// Generated by CoffeeScript 1.4.0
(function() {
  var DateTool, EscapeTool, MathTool, NumberTool, Velocity, contentType, fs, slice, syspath, sysurl, urlrouter, utils, vm;

  fs = require("fs");

  vm = require("vm");

  urlrouter = require("urlrouter");

  Velocity = require("velocityjs");

  utils = require('../util');

  sysurl = require("url");

  syspath = require("path");

  contentType = {
    'Content-Type': "text/html;charset=UTF-8"
  };

  module.exports = function(req, res, next, options) {
    var ROOT, conf, ctx, macros, p, url, vmc, vmjs_path, vmjson_path, _get_path, _render;
    ROOT = options.cwd;
    url = sysurl.parse(req.url);
    p = syspath.join(ROOT, url.pathname);
    vmjs_path = p.replace('.vm', '.vmjs');
    vmjson_path = p.replace('.vm', '.json');
    conf = utils.config.parse(p);
    vmc = null;
    _get_path = function(path) {
      var root, _p, _ref, _ref1;
      if (utils.path.is_absolute_path(path) && fs.existsSync(path)) {
        return path;
      }
      root = conf != null ? (_ref = conf.root) != null ? (_ref1 = _ref.development) != null ? _ref1.velocity_root : void 0 : void 0 : void 0;
      if (root) {
        root = utils.path.join(conf.fekit_root_dirname, root);
        _p = utils.path.join(root, path.replace(/^\//, './'));
        if (!fs.existsSync(_p)) {
          _p = utils.path.join(root, "../refs/vm", path.replace(/^\//, './'));
        }
      } else {
        _p = utils.path.join(utils.path.dirname(p), path);
      }
      return _p;
    };
    _render = function(path, ctx, macros, is_layout) {
      var asts, content, s, _layout_path;
      content = utils.file.io.read(_get_path(path));
      content = utils.replaceEnvironmentConfig('text', content, conf.getEnvironmentConfig()[utils.getCurrentEnvironment(options)]);
      asts = Velocity.Parser.parse(content);
      if (!vmc) {
        vmc = new Velocity.Compile(asts);
        s = vmc.render(ctx, macros);
      } else {
        s = vmc._render(asts);
      }
      if (ctx && ctx.layout && !is_layout) {
        _layout_path = ctx.layout;
        ctx.layout = null;
        ctx.screen_content = s;
        s = _render(_layout_path, ctx, macros, true);
      }
      return s;
    };
    if (utils.path.exists(vmjs_path)) {
      delete require.cache[vmjs_path];
      ctx = utils.proc.requireScript(vmjs_path, {
        request: req,
        response: res,
        utils: utils
      });
    } else if (utils.path.exists(vmjson_path)) {
      ctx = utils.file.io.readJSON(vmjson_path);
    } else {
      ctx = {};
    }
    ctx.esc = EscapeTool;
    ctx.date = DateTool;
    ctx.math = MathTool;
    ctx.number = NumberTool;
    macros = {
      load: function(path) {
        return this.jsmacros.parse.call(this, path);
      },
      parse: function(path) {
        return _render(path, this.context, this.jsmacros);
      },
      include: function(path) {
        return utils.file.io.read(_get_path(path));
      },
      ver: function(path) {
        return '';
      }
    };
    res.writeHead(200, contentType);
    return res.end(_render(p, ctx, macros));
  };

  EscapeTool = {};

  EscapeTool.html = function(str) {
    return String(str).replace(/&(?!\w+;)/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  };

  EscapeTool.javascript = function(str) {
    return String(str).replace(/\\/g, '\\\\').replace(/'/g, '\\\'').replace(/"/g, '\\\"').replace(/\//g, '//');
  };

  EscapeTool.url = function(str) {
    return encodeURIComponent(str);
  };

  EscapeTool.java = function(str) {
    return String(str).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"');
  };

  EscapeTool.json = function(str) {
    return String(str).replace(/\\/g, '\\\\').replace(/\"/g, '\\\"').replace(/\//g, '//');
  };

  MathTool = {};

  slice = function(arry, pos) {
    return Array.prototype.slice.call(arry, pos);
  };

  MathTool.add = function(num1, num2) {
    var tmp, v, _i, _len;
    v = 0;
    for (_i = 0, _len = arguments.length; _i < _len; _i++) {
      tmp = arguments[_i];
      v += parseFloat(tmp);
    }
    return v;
  };

  MathTool.sub = function(num1, num2) {
    var tmp, v, _i, _len, _ref;
    v = parseFloat(num1);
    _ref = slice(arguments, 1);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tmp = _ref[_i];
      v -= parseFloat(tmp);
    }
    return v;
  };

  MathTool.mul = function(num1, num2) {
    var tmp, v, _i, _len;
    v = 1;
    for (_i = 0, _len = arguments.length; _i < _len; _i++) {
      tmp = arguments[_i];
      v *= parseFloat(~~tmp);
    }
    return v;
  };

  MathTool.div = function(num1, num2) {
    var tmp, v, _i, _len, _ref;
    v = parseFloat(num1);
    _ref = slice(arguments, 1);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tmp = _ref[_i];
      tmp = parseFloat(tmp);
      if (tmp === 0) {
        return null;
      }
      v /= tmp;
    }
    return v;
  };

  MathTool.max = function(num1, num2) {
    var tmp, v, _i, _len, _ref;
    v = parseFloat(num1);
    _ref = slice(arguments, 1);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tmp = _ref[_i];
      tmp = parseFloat(tmp);
      v < tmp && (v = tmp);
    }
    return v;
  };

  MathTool.min = function(num1, num2) {
    var tmp, v, _i, _len, _ref;
    v = parseFloat(num1);
    _ref = slice(arguments, 1);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      tmp = _ref[_i];
      tmp = parseFloat(tmp);
      v > tmp && (v = tmp);
    }
    return v;
  };

  MathTool.pow = function(num1, num2) {
    if (!num1 || !num2) {
      return null;
    }
    return Math.pow(num1, num2);
  };

  MathTool.floor = function(num1, num2) {
    if (!num1 || !num2) {
      return null;
    }
    return Math.floor(num1, num2);
  };

  MathTool.idiv = function(num1, num2) {
    if (!num1 || !num2 || ~~num2 === 0) {
      return null;
    }
    return ~~(~~num1 / ~~num2);
  };

  MathTool.mod = function(num1, num2) {
    if (!num1 || !num2 || ~~num2 === 0) {
      return null;
    }
    return ~~(~~num1 % ~~num2);
  };

  MathTool.abs = function(num) {
    if (!num) {
      return null;
    }
    return Math.abs(parseFloat(num));
  };

  MathTool.ceil = function(num) {
    if (!num) {
      return null;
    }
    return ~~Math.ceil(parseFloat(num));
  };

  MathTool.random = function() {
    return Math.random();
  };

  NumberTool = {};

  NumberTool.interger = function(v) {
    return ~~v;
  };

  NumberTool.currency = function(v) {
    return '$' + v;
  };

  NumberTool.percent = function(v) {
    return v * 100 + '%';
  };

  NumberTool.format = function(v) {
    return Math.round(v * 10) / 10;
  };

  DateTool = {};

  DateTool.getSystemDate = function() {
    return new Date();
  };

  DateTool.getYear = function() {
    return new Date().getFullYear();
  };

  DateTool.getMonth = function() {
    return new Date().getMonth() + 1;
  };

  DateTool.getDay = function() {
    return new Date().getDate();
  };

}).call(this);
